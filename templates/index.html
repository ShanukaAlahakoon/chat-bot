<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Elegant Gemini RAG Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
      }
      /* Chat bubble styling for elegance */
      .user-message {
        background-color: #3b82f6; /* Blue-500 */
        color: white;
        border-top-left-radius: 1.5rem;
        border-bottom-left-radius: 1.5rem;
        border-bottom-right-radius: 0.5rem;
      }
      .ai-message {
        background-color: #f1f5f9; /* Slate-100 */
        color: #1e293b; /* Slate-800 */
        border-top-right-radius: 1.5rem;
        border-bottom-right-radius: 1.5rem;
        border-bottom-left-radius: 0.5rem;
      }
      #chat-window {
        max-height: calc(95vh - 120px);
      }
      /* Custom Loading indicator */
      .dot-pulse {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #60a5fa;
        margin: 0 2px;
        animation: dot-pulse 1.5s infinite ease-in-out;
      }
      .dot-pulse:nth-child(2) {
        animation-delay: 0.2s;
      }
      .dot-pulse:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes dot-pulse {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center p-4">
    <div
      class="w-full max-w-5xl bg-white shadow-2xl rounded-2xl flex flex-col h-[95vh] overflow-hidden"
    >
      <header
        class="p-4 border-b bg-blue-600 text-white flex items-center justify-between shadow-lg"
      >
        <h1 class="text-3xl font-extrabold tracking-tight flex items-center">
          <span class="mr-3">ðŸ“„</span> Document Search powered by Gemini RAG
        </h1>
        <div
          id="doc-status"
          class="text-sm font-medium bg-blue-700 py-2 px-4 rounded-full shadow-md transition duration-300"
        >
          Knowledge Base Empty
        </div>
      </header>

      <main class="flex-grow flex min-h-0">
        <div class="w-1/3 p-6 border-r flex flex-col space-y-6 bg-gray-50">
          <h2 class="text-xl font-bold text-gray-800 pb-2">
            Load Document to Database
          </h2>

          <form id="upload-form" class="space-y-4">
            <input
              type="file"
              id="pdf-file"
              name="file"
              accept=".pdf"
              required
              class="w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 cursor-pointer transition"
            />
            <button
              type="submit"
              id="upload-button"
              class="w-full px-4 py-3 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-150 disabled:bg-gray-400"
            >
              Process PDF & Index Chunks
            </button>
          </form>

          <div
            id="upload-message"
            class="text-sm p-4 rounded-lg hidden border"
            role="alert"
          ></div>

          <div class="border-t pt-6 space-y-3">
            <h3 class="text-lg font-bold text-gray-700">RAG Status</h3>
            <p class="text-sm text-gray-600">
              The knowledge base (ChromaDB) stores embeddings from all uploaded
              documents. Questions query the entire index.
            </p>
          </div>
        </div>

        <div class="w-2/3 flex flex-col p-6 min-h-0">
          <div
            id="chat-window"
            class="flex-grow overflow-y-auto space-y-4 pr-2 mb-4"
          >
            <div class="flex w-full justify-start">
              <div class="ai-message max-w-xl p-4 shadow-md">
                Welcome! Upload a PDF on the left to create your knowledge base
                and begin querying your documents!
              </div>
            </div>
          </div>

          <form
            id="chat-form"
            class="flex items-center space-x-3 pt-4 border-t border-gray-100"
          >
            <input
              type="text"
              id="user-prompt"
              placeholder="Ask a question about the indexed documents..."
              class="flex-grow p-4 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-200 shadow-inner"
              required
              disabled
            />
            <button
              type="submit"
              id="send-button"
              class="px-6 py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition duration-150 disabled:bg-gray-400"
              disabled
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M14 5l7 7m0 0l-7 7m7-7H3"
                ></path>
              </svg>
            </button>
          </form>
        </div>
      </main>
    </div>

    <script>
      const API_BASE_URL = "http://127.0.0.1:5000";

      const uploadForm = document.getElementById("upload-form");
      const chatForm = document.getElementById("chat-form");
      const chatWindow = document.getElementById("chat-window");
      const uploadMessage = document.getElementById("upload-message");
      const docStatus = document.getElementById("doc-status");
      const userPromptInput = document.getElementById("user-prompt");
      const sendButton = document.getElementById("send-button");
      const uploadButton = document.getElementById("upload-button");

      let isDatabaseReady = false;

      function addMessage(sender, text) {
        const messageContainer = document.createElement("div");
        messageContainer.classList.add("flex", "w-full", "mb-3");

        const messageBubble = document.createElement("div");
        messageBubble.classList.add(
          "max-w-xl",
          "p-4",
          "shadow-lg",
          "font-medium",
          "whitespace-pre-wrap"
        );

        if (sender === "user") {
          messageContainer.classList.add("justify-end");
          messageBubble.classList.add("user-message");
        } else {
          messageContainer.classList.add("justify-start");
          messageBubble.classList.add("ai-message");
        }

        messageBubble.textContent = text;
        messageContainer.appendChild(messageBubble);
        chatWindow.appendChild(messageContainer);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function setLoading(isLoading) {
        if (isLoading) {
          const loadingContainer = document.createElement("div");
          loadingContainer.id = "loading-message";
          loadingContainer.classList.add(
            "flex",
            "w-full",
            "justify-start",
            "mb-3"
          );

          const loadingBubble = document.createElement("div");
          loadingBubble.classList.add(
            "ai-message",
            "p-4",
            "shadow-md",
            "flex",
            "items-center",
            "space-x-1",
            "font-normal"
          );
          loadingBubble.innerHTML = `
                          <div class="flex items-center space-x-1">
                              <div class="dot-pulse"></div>
                              <div class="dot-pulse"></div>
                              <div class="dot-pulse"></div>
                          </div>
                      `;
          loadingContainer.appendChild(loadingBubble);
          chatWindow.appendChild(loadingContainer);
        } else {
          document.getElementById("loading-message")?.remove();
        }
        userPromptInput.disabled = isLoading || !isDatabaseReady;
        sendButton.disabled = isLoading || !isDatabaseReady;
      }

      function setUploadMessage(text, isError = false) {
        uploadMessage.textContent = text;
        uploadMessage.classList.remove(
          "hidden",
          "bg-red-100",
          "text-red-700",
          "border-red-300",
          "bg-green-100",
          "text-green-700",
          "border-green-300"
        );
        if (isError) {
          uploadMessage.classList.add(
            "bg-red-100",
            "text-red-700",
            "border-red-300"
          );
        } else {
          uploadMessage.classList.add(
            "bg-green-100",
            "text-green-700",
            "border-green-300"
          );
        }
      }

      let currentDocId = null;

      function setChatEnabled(enabled, filename = null) {
        isDatabaseReady = enabled;
        userPromptInput.disabled = !enabled;
        sendButton.disabled = !enabled;
        if (enabled) {
          currentDocId = filename; // <-- Store for chat requests!
          docStatus.textContent = filename
            ? `${filename} Indexed`
            : "Database Ready";
          docStatus.classList.remove("bg-blue-700", "bg-red-500");
          docStatus.classList.add("bg-green-500");
          userPromptInput.focus();
          if (filename) {
            addMessage(
              "ai",
              `Document **${filename}** has been successfully added to the knowledge base. You can now ask questions!`
            );
          }
        } else {
          currentDocId = null; // <-- Reset if not enabled
          docStatus.textContent = "Knowledge Base Empty";
          docStatus.classList.remove("bg-green-500");
          docStatus.classList.add("bg-blue-700");
        }
      }

      // --- Upload Handler (Ingestion Pipeline) ---
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const fileInput = document.getElementById("pdf-file");
        const file = fileInput.files[0];

        if (!file) return;

        setChatEnabled(false);
        uploadButton.textContent = "Processing & Embedding...";
        uploadButton.disabled = true;
        uploadMessage.classList.add("hidden");

        const formData = new FormData();
        formData.append("file", file);

        // Temporary message
        addMessage("ai", `Starting ingestion for: **${file.name}**...`);
        setLoading(true);

        try {
          const response = await fetch(`${API_BASE_URL}/upload`, {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (response.ok) {
            setUploadMessage(
              `Success! Text from ${file.name} indexed in ChromaDB.`,
              false
            );
            setChatEnabled(true, file.name);
          } else {
            setUploadMessage(
              `Error: ${result.error || "Failed to process file."}`,
              true
            );
            setChatEnabled(false);
          }
        } catch (error) {
          setUploadMessage(
            `Connection failed. Is the Flask server running at ${API_BASE_URL}?`,
            true
          );
          setChatEnabled(false);
        } finally {
          uploadButton.textContent = "Process PDF & Index Chunks";
          uploadButton.disabled = false;
          setLoading(false);
        }
      });

      // --- Chat Handler (Retrieval & Generation Pipeline) ---
      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const prompt = userPromptInput.value.trim();
        if (!prompt || !isDatabaseReady || !currentDocId) return; // Make sure doc_id is present

        addMessage("user", prompt);
        userPromptInput.value = "";

        setLoading(true);

        try {
          const response = await fetch(`${API_BASE_URL}/ask`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: prompt, doc_id: currentDocId }), // <-- CORRECT
          });

          const result = await response.json();

          if (response.ok) {
            addMessage("ai", result.answer);
          } else {
            addMessage(
              "ai",
              `[Server Error]: ${result.error || "Unknown error occurred."}`
            );
          }
        } catch (error) {
          addMessage(
            "ai",
            `[Connection Error]: Could not reach the API endpoint.`
          );
        } finally {
          setLoading(false);
        }
      });

      // Initial setup
      document.addEventListener("DOMContentLoaded", () => {
        // Check if ChromaDB has any data on initial load
        // For a truly persistent check, you'd need a separate endpoint to query ChromaDB count.
        // For simplicity, we assume it starts empty.
      });
    </script>
  </body>
</html>
